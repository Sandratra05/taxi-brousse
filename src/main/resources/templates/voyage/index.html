<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
    <title>Liste des voyages</title>
    <link rel="stylesheet" th:href="@{/css/sidebar.css}">
</head>
<body>

<div th:replace="fragments/sidebar :: sidebar"></div>

<div class="content">

    <h1>Liste des voyages</h1>

    <a th:href="@{/voyages/form}">Nouveau voyage</a>

    <div class="actions-buttons">
        <a th:href="@{/voyages/chiffreAffaire}" class="btn">
            <i class="fas fa-chart-line"></i> Voir Chiffre d'affaires
        </a>
    </div>

    <!-- Totaux des chiffres d'affaires -->
    <div style="border:2px solid #2c3e50; padding:20px; margin-bottom:20px; background:#ecf0f1; border-radius:8px;">
        <h3 style="margin-top:0; color:#2c3e50;">Résumé des Chiffres d'Affaires</h3>
        <div style="display:flex; flex-wrap:wrap; gap:20px;">
            <div style="flex:1; min-width:200px; background:#3498db; color:white; padding:15px; border-radius:5px; text-align:center;">
                <strong>Total Tickets</strong><br/>
                <span style="font-size:1.3em;" th:text="${#numbers.formatDecimal(totalRevenueTickets, 0, 'COMMA', 2, 'POINT')} + ' AR'">0 AR</span>
            </div>
            <div style="flex:1; min-width:200px; background:#9b59b6; color:white; padding:15px; border-radius:5px; text-align:center;">
                <strong>Total Publicités</strong><br/>
                <span style="font-size:1.3em;" th:text="${#numbers.formatDecimal(totalRevenuePublicites, 0, 'COMMA', 2, 'POINT')} + ' AR'">0 AR</span>
            </div>
            <div style="flex:1; min-width:200px; background:#e67e22; color:white; padding:15px; border-radius:5px; text-align:center;">
                <strong>Total Produits Extra</strong><br/>
                <span style="font-size:1.3em;" th:text="${#numbers.formatDecimal(totalRevenueProduits, 0, 'COMMA', 2, 'POINT')} + ' AR'">0 AR</span>
            </div>
            <div style="flex:1; min-width:200px; background:#27ae60; color:white; padding:15px; border-radius:5px; text-align:center;">
                <strong>Chiffre d'Affaires Total</strong><br/>
                <span style="font-size:1.5em; font-weight:bold;" th:text="${#numbers.formatDecimal(totalRevenueGlobal, 0, 'COMMA', 2, 'POINT')} + ' AR'">0 AR</span>
            </div>
        </div>
    </div>

    <form action="/voyages" method="get" style="border:1px solid #ccc; padding:15px; margin-bottom:20px; background:#f9f9f9;">
        <h3>Filtrer les voyages</h3>

        <label>Trajet:
            <select name="trajetId">
                <option value="">-- Tous --</option>
                <option th:each="t : ${trajets}" 
                        th:value="${t.id}" 
                        th:text="${t.gareDepart.nom + ' → ' + t.gareArrivee.nom}"
                        th:selected="${trajetId != null && trajetId == t.id}"></option>
            </select>
        </label>
        
        <label>Chauffeur:
            <select name="chauffeurId">
                <option value="">-- Tous --</option>
                <option th:each="c : ${chauffeurs}" 
                        th:value="${c.id}" 
                        th:text="${c.nom + ' ' + c.prenom}"
                        th:selected="${chauffeurId != null && chauffeurId == c.id}"></option>
            </select>
        </label>
        
        <label>Véhicule:
            <select name="vehiculeId">
                <option value="">-- Tous --</option>
                <option th:each="v : ${vehicules}" 
                        th:value="${v.id}" 
                        th:text="${v.immatriculation}"
                        th:selected="${vehiculeId != null && vehiculeId == v.id}"></option>
            </select>
        </label>
        
        <label>Statut:
            <select name="statutId">
                <option value="">-- Tous --</option>
                <option th:each="s : ${statuts}" 
                        th:value="${s.id}"
                        th:text="${s.libelle}"
                        th:selected="${statutId != null && statutId == s.id}"></option>
            </select>
        </label>
        
        <br/>
        
        <label>Date début: 
            <input type="datetime-local" name="dateDebut" th:value="${dateDebut}"/>
        </label>
        
        <label>Date fin: 
            <input type="datetime-local" name="dateFin" th:value="${dateFin}"/>
        </label>
        
        <br/>
        
        <button type="submit">Filtrer</button>
        <a href="/voyages">Réinitialiser</a>
    </form>

    <table>
        <thead>
        <tr>
            <th>Gare Routier Depart</th>
            <th>Gare Routier Arriver</th>
            <th>Véhicule</th>
            <th>Date départ</th>
            <th>Heure départ</th>
            <th>Montant genere par tickets vendus</th>
            <th>Montant genere par diffusion publicites</th>
            <th>Montant genere par produits extra</th>
            <th>Montant payé publicites</th>
            <th>Reste à payer publicites</th>
            <th>Montant Chiffre Affaire Total</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="item : ${voyagesWithStatus}">
            <td><strong th:text="${item.gareDepart}"></strong></td>
            <td th:text="${item.gareArrivee}"></td>
            <td th:text="${item.vehicule}"></td>
            <td th:text="${item.date != null ? #temporals.format(item.date, 'yyyy-MM-dd') : '-'}"></td>
            <td th:text="${item.heure != null ? #temporals.format(item.heure, 'HH:mm') : '-'}"></td>
            <td>
                <span th:if="${placesParCategorie[item.voyage.id] != null}" 
                      th:text="${#numbers.formatDecimal(placesParCategorie[item.voyage.id].revenueTickets, 0, 'COMMA', 2, 'POINT')} + ' AR'"></span>
                <span th:if="${placesParCategorie[item.voyage.id] == null}">0 AR</span>
            </td>
            <td>
                <span th:if="${placesParCategorie[item.voyage.id] != null}" 
                      th:text="${#numbers.formatDecimal(placesParCategorie[item.voyage.id].revenuePublicites, 0, 'COMMA', 2, 'POINT')} + ' AR'"></span>
                <span th:if="${placesParCategorie[item.voyage.id] == null}">0 AR</span>
            </td>
            <td>
                <span th:if="${placesParCategorie[item.voyage.id] != null}" 
                      th:text="${#numbers.formatDecimal(placesParCategorie[item.voyage.id].revenueProduits, 0, 'COMMA', 2, 'POINT')} + ' AR'"></span>
                <span th:if="${placesParCategorie[item.voyage.id] == null}">0 AR</span>
            </td>
            <td>
                <span th:if="${placesParCategorie[item.voyage.id] != null}" 
                      th:text="${#numbers.formatDecimal(placesParCategorie[item.voyage.id].montantPayePublicites, 0, 'COMMA', 2, 'POINT')} + ' AR'"></span>
                <span th:if="${placesParCategorie[item.voyage.id] == null}">0 AR</span>
            </td>
            <td>
                <span th:if="${placesParCategorie[item.voyage.id] != null}" 
                      th:text="${#numbers.formatDecimal(placesParCategorie[item.voyage.id].resteAPayerPublicites, 0, 'COMMA', 2, 'POINT')} + ' AR'"></span>
                <span th:if="${placesParCategorie[item.voyage.id] == null}">0 AR</span>
            </td>
            <td>
                <span th:if="${placesParCategorie[item.voyage.id] != null}" 
                      th:text="${#numbers.formatDecimal(placesParCategorie[item.voyage.id].revenueTotal, 0, 'COMMA', 2, 'POINT')} + ' AR'"></span>
                <span th:if="${placesParCategorie[item.voyage.id] == null}">0 AR</span>
            </td>
        </tr>
        <tr th:if="${#lists.isEmpty(voyages)}">
            <td colspan="10">Aucun voyage.</td>
        </tr>
        </tbody>
    </table>

</div>

</body>
</html>